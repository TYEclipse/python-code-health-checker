# Python Code Health Checker - 设计文档

## 概述

Python Code Health Checker 是一个专业的代码库结构健康度自动化检查工具，通过精确的AST解析来识别代码行数超标的文件和函数。本文档详细说明了该工具的设计思想、架构和实现细节。

## 核心需求

该工具需要满足以下核心需求：

1. **精确的有效代码行计算**：必须能够准确排除空行、注释和文档字符串
2. **灵活的配置**：支持自定义阈值、排除目录和输出格式
3. **多格式输出**：支持控制台、JSON和HTML三种报告格式
4. **零依赖**：仅使用Python标准库，确保最大的可移植性
5. **生产就绪**：经过充分测试，可直接用于CI/CD流程

## 架构设计

### 分层架构

该工具采用分层设计，主要由以下几个类构成：

```
┌─────────────────────────────────────────────────────────┐
│                  命令行接口 (CLI)                        │
├─────────────────────────────────────────────────────────┤
│              CodeHealthChecker (主控制类)                │
├─────────────────────────────────────────────────────────┤
│  CodeLineCounter  │  FunctionExtractor  │  报告生成模块   │
├─────────────────────────────────────────────────────────┤
│              Python AST 模块 (标准库)                    │
└─────────────────────────────────────────────────────────┘
```

### 核心类设计

#### 1. CodeLineCounter

**职责**：计算代码的有效行数

**关键方法**：
- `__init__(source_code, file_path)`: 初始化计数器，解析AST以识别文档字符串
- `_identify_docstrings()`: 识别所有文档字符串的行号范围
- `_extract_docstring_nodes(node)`: 从AST中提取文档字符串节点
- `count_effective_lines(start_line, end_line)`: 计算指定范围内的有效行数

**工作流程**：

```
输入源代码
    ↓
解析AST
    ↓
识别文档字符串位置
    ↓
逐行分析（排除空行、注释、文档字符串）
    ↓
返回有效行数
```

#### 2. FunctionExtractor

**职责**：从AST中提取函数和方法信息

**继承**：`ast.NodeVisitor`

**关键方法**：
- `visit_ClassDef(node)`: 访问类定义节点
- `visit_FunctionDef(node)`: 访问函数定义节点
- `visit_AsyncFunctionDef(node)`: 访问异步函数定义节点
- `_process_function(node)`: 处理函数节点，计算其有效行数

**工作流程**：

```
AST根节点
    ↓
遍历所有节点
    ↓
识别函数/方法定义
    ↓
记录函数信息（名称、位置、行数）
    ↓
返回函数列表
```

#### 3. CodeHealthChecker

**职责**：主控制类，协调整个检查过程

**关键方法**：
- `__init__(...)`: 初始化检查器，设置阈值和排除规则
- `should_exclude(file_path)`: 判断文件是否应被排除
- `scan()`: 扫描项目目录
- `_check_file(file_path)`: 检查单个文件
- `generate_console_report()`: 生成控制台报告
- `generate_json_report(output_file)`: 生成JSON报告
- `generate_html_report(output_file)`: 生成HTML报告

**工作流程**：

```
初始化检查器
    ↓
递归遍历目录
    ↓
过滤排除的文件
    ↓
对每个Python文件执行检查
    ├─ 计算文件有效行数
    ├─ 提取函数信息
    └─ 与阈值比较
    ↓
收集所有问题
    ↓
生成报告
```

## 有效代码行定义

有效代码行（ELOC）的精确定义对工具的准确性至关重要。

### 排除项

1. **空行**：完全不包含任何字符或仅包含空白字符的行
   ```python
   # 这是空行
   
   ```

2. **单行注释**：以 `#` 开头的行
   ```python
   # 这是一个注释
   x = 1  # 这行不是注释，因为有代码
   ```

3. **文档字符串**：作为模块、函数、类或方法的第一个语句的字符串字面量
   ```python
   def my_function():
       """这是文档字符串，不计入有效行数"""
       x = 1  # 这行计入有效行数
   ```

### 包含项

所有其他包含实际代码逻辑的行，包括：
- 变量赋值
- 函数调用
- 控制流语句（if, for, while等）
- 类定义
- 导入语句
- 代码中的注释（在代码行之后）

## 实现细节

### AST解析策略

该工具使用Python的 `ast` 模块来精确地识别代码结构：

1. **解析源代码**：使用 `ast.parse()` 生成AST
2. **遍历AST**：使用 `ast.NodeVisitor` 访问各个节点
3. **识别文档字符串**：检查每个函数/类/模块的第一个语句是否为 `ast.Expr` 节点，其值为 `ast.Constant` 字符串
4. **记录位置信息**：利用节点的 `lineno` 和 `end_lineno` 属性

### 排除规则

排除规则分为两类：

1. **目录排除**：通过目录名称匹配
   - 默认排除：`__pycache__`, `.git`, `.venv`, `venv`, `env` 等
   - 可配置：通过 `--exclude-dir` 参数或配置文件

2. **文件模式排除**：通过正则表达式匹配
   - 默认排除：`*.pyc`, `__pycache__/*`, `*.egg-info/*` 等

### 报告生成

#### 控制台报告

使用格式化的文本表格，包含：
- 摘要统计
- 超标文件列表
- 每个文件的超标函数列表

#### JSON报告

结构化的JSON格式，便于机器解析和CI/CD集成：

```json
{
  "summary": { ... },
  "issues": [ ... ]
}
```

#### HTML报告

交互式的HTML页面，特性包括：
- 响应式设计
- 可折叠的文件/函数列表
- 美观的样式和图表

## 性能考虑

### 时间复杂度

- **文件扫描**：O(n)，其中n为文件总数
- **AST解析**：O(m)，其中m为源代码行数
- **整体复杂度**：O(n*m)，但实际上由于文件大小有限，性能很好

### 空间复杂度

- **AST存储**：O(m)，与源代码大小成正比
- **结果存储**：O(k)，其中k为超标项数量（通常很小）

### 优化措施

1. **增量处理**：逐个文件处理，不需要一次性加载整个项目
2. **早期退出**：一旦超过阈值就停止计算
3. **缓存**：可选的缓存机制（未来扩展）

## 扩展性

该设计具有很好的扩展性，可以轻松添加新的检查维度：

### 可能的扩展

1. **圈复杂度检查**：基于AST计算函数的圈复杂度
2. **命名规范检查**：验证变量、函数、类的命名是否符合规范
3. **代码异味检测**：识别常见的代码问题（如重复代码、长参数列表等）
4. **依赖分析**：分析模块间的依赖关系
5. **增量检查**：只检查变更的文件

### 扩展示例

添加新的检查器只需：

1. 创建新的 `Checker` 类
2. 实现 `check()` 方法
3. 将其集成到 `CodeHealthChecker`

```python
class ComplexityChecker:
    def check(self, file_path):
        # 实现复杂度检查逻辑
        pass
```

## 测试策略

### 单元测试

覆盖以下场景：

1. **有效行数计算**
   - 空文件
   - 仅包含注释的文件
   - 包含文档字符串的文件
   - 混合代码

2. **函数提取**
   - 普通函数
   - 方法
   - 异步函数
   - 嵌套函数

3. **排除规则**
   - 目录排除
   - 文件模式排除
   - 组合排除

4. **报告生成**
   - 控制台输出格式
   - JSON结构
   - HTML有效性

### 集成测试

使用示例项目进行端到端测试，验证整个流程的正确性。

## 已知限制

1. **编码问题**：假设源文件为UTF-8编码
2. **语法错误**：无法解析有语法错误的Python文件（会跳过）
3. **动态代码**：无法分析通过 `exec()` 或 `eval()` 执行的代码
4. **类型检查**：不进行类型检查，仅基于代码结构

## 未来改进

1. **性能优化**：实现增量检查和缓存机制
2. **更多指标**：添加圈复杂度、代码覆盖率等指标
3. **可视化**：生成更丰富的图表和可视化报告
4. **集成**：与更多IDE和编辑器集成
5. **国际化**：支持多语言输出

## 参考资源

- [Python AST 文档](https://docs.python.org/3/library/ast.html)
- [PEP 8 风格指南](https://www.python.org/dev/peps/pep-0008/)
- [代码复杂度度量](https://en.wikipedia.org/wiki/Cyclomatic_complexity)

---

**版本**：1.0  
**最后更新**：2025年12月07日
